# ğŸ”§ Fixing 502 Errors on Render

## âœ… Changes Made

1. **Reduced Gunicorn Workers**: 4 â†’ 2 (reduces memory usage)
2. **Added Timeout**: 120 seconds (prevents premature timeouts for AI API calls)

## ğŸš€ Deploy Steps

```bash
# Push the changes
git push origin main  # or your branch name
```

Render will automatically detect the changes and redeploy.

## ğŸ” Debugging Checklist

### 1. Check Render Logs
- Go to: https://dashboard.render.com
- Click your service â†’ "Logs" tab
- Look for errors when 502 occurs

### 2. Verify Environment Variables
Make sure these are set in Render Dashboard â†’ Environment:

**Required:**
- `DB_HOST` - Your MySQL database host
- `DB_USER` - Database username
- `DB_PASSWORD` - Database password
- `DB_NAME` - Database name
- `SECRET_KEY` - Auto-generated by Render

**AI Provider (at least ONE required):**
- `DEEPSEEK_API_KEY` - DeepSeek API key
- `GROQ_API_KEY` - Groq API key
- `OPENAI_API_KEY` - OpenAI API key

**Optional:**
- `MASTER_API_KEY` - Master API key for admin access

### 3. Test Endpoints

Test these URLs (replace with your Render URL):

```bash
# Health check (should work)
curl https://your-app.onrender.com/health

# Root endpoint
curl https://your-app.onrender.com/

# AI endpoint (requires auth)
curl -X POST https://your-app.onrender.com/api/v1/ai/ask \
  -H "Content-Type: application/json" \
  -d '{"question":"Hello","user_id":1,"user_role":1}'
```

## ğŸ› Common Issues & Solutions

### Issue: 502 after ~30 seconds
**Cause:** Request timeout  
**Solution:** âœ… Fixed with `--timeout 120` in render.yaml

### Issue: 502 immediately
**Cause:** Application crash on startup  
**Solution:** Check Render logs for Python errors

### Issue: 502 on AI queries only
**Cause:** Missing AI API key  
**Solution:** Set `DEEPSEEK_API_KEY`, `GROQ_API_KEY`, or `OPENAI_API_KEY`

### Issue: 502 on all endpoints
**Cause:** Database connection failure  
**Solution:** Verify `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`

### Issue: "Out of memory" in logs
**Cause:** Too many workers or memory-intensive operations  
**Solution:** âœ… Reduced workers to 2

## ğŸ“Š What to Check in Logs

Look for these error patterns:

```
âŒ "TimeoutError" â†’ AI API taking too long (fixed with timeout increase)
âŒ "KeyError: 'DEEPSEEK_API_KEY'" â†’ Missing environment variable
âŒ "Can't connect to MySQL" â†’ Database connection issue
âŒ "Out of memory" â†’ Resource limit (fixed with fewer workers)
âŒ "ModuleNotFoundError" â†’ Missing dependency in requirements.txt
```

## ğŸ¯ Next Steps

1. **Push the changes:**
   ```bash
   git push origin main
   ```

2. **Wait for Render to redeploy** (2-3 minutes)

3. **Test the endpoints** again

4. **If still failing:**
   - Check Render logs
   - Share the error messages
   - Verify environment variables

## ğŸ’¡ Additional Optimizations (if needed)

If you still experience issues, consider:

1. **Upgrade Render Plan** - Free tier has limited resources
2. **Add Redis Caching** - Cache AI responses
3. **Implement Request Queuing** - Use Celery for long-running tasks
4. **Optimize AI Calls** - Reduce the number of sequential AI API calls

## ğŸ“ Support

If the issue persists after these fixes:
1. Share the Render logs
2. Specify which endpoint is failing
3. Share any error messages from the frontend
